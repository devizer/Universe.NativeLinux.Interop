# AGENT_OS=Linux|Darwin|Windows_NT

steps:

  - bash: |
      sudo rm -f /usr/local/bin/Say || true
      script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools-bundle.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash
      echo "AGENT_OS: '${AGENT_OS}'"
      dotnet --info
    displayName: 'Install dotnet sdk 3.1 on linux/osx'

  - script: |
      time list-packages
    condition: eq(variables['OS'], 'Linux')
    displayName: 'List Packages'

  - script: |
      pushd so-src>/dev/null
      bash re-build-local.sh
      popd>/dev/null
    displayName: 're-build-local.sh'

  - script: |
      pushd so-src>/dev/null
      bash rebuild-all.sh
      popd>/dev/null
    displayName: 'rebuild-all.sh: libNativeLinuxInterop.so'

  - script: |
      pushd so-src>/dev/null
      bash deploy-to-runtimes.sh
      popd>/dev/null
    displayName: 'reset versioned runtimes: deploy-to-runtimes.sh'

  - script: |
      pushd Universe.LinuxTaskstat>/dev/null
      dotnet test -f netcoreapp3.1 -c Debug
      popd>/dev/null
    displayName: 'dotnet test'

  - script: |
      pushd Universe.LinuxTaskstat/Universe.LinuxTaskstat>/dev/null
      bash build-nuget.sh
      popd>/dev/null
    displayName: 'build nuget'


  - script: |
      Show-System-Stat || true
      df -h -T
    condition: succeededOrFailed()
    displayName: 'System Stat'

  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      pathtoPublish: '$(Build.Repository.LocalPath)/so-src/runtimes'
      artifactName: 'Runtimes'
      
  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    inputs:
      pathtoPublish: '$(Build.Repository.LocalPath)'
      artifactName: 'Working'
      
